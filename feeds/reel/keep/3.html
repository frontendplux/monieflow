<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TikTok-style Video + Music Recorder</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/remixicon/fonts/remixicon.css" rel="stylesheet">
<style>
body { margin:0; background:#111; color:white; font-family:sans-serif; }

#preview { object-fit:cover; width:100%; height:100%; position:fixed; top:0; left:0; }

.record-wrapper {
    position: relative;
    width: 100px;
    height: 100px;
    display: flex;
    justify-content: center;
    align-items: center;
}

svg { position: absolute; transform: rotate(-90deg); }

circle { fill:none; stroke-width:6; }
.progress-bg { stroke:#333; }
.progress-bar { stroke:red; stroke-dasharray:283; stroke-dashoffset:283; transition:none; }

.record-btn {
    width:70px; height:70px; background:red; border-radius:50%; border:none; cursor:pointer; z-index:10; transition: transform 0.2s ease;
    display:flex; justify-content:center; align-items:center; font-weight:bold; color:white; font-size:20px;
}
.record-btn.pulsing { animation: pulse 0.5s infinite alternate; }

@keyframes pulse {
    0% { transform: scale(0.9); }
    100% { transform: scale(1.1); }
}

#controls { position:fixed; bottom:80px; left:50%; transform:translateX(-50%); width:300px; }
</style>
</head>
<body>

<!-- Fullscreen video preview -->
<video id="preview" autoplay muted></video>

<!-- Bottom control bar -->
<div class="position-fixed bottom-0 start-0 end-0 d-flex justify-content-around align-items-center mb-4">
    <div style="width:50px;"></div>
    <div class="record-wrapper">
        <svg width="100" height="100">
            <circle class="progress-bg" cx="50" cy="50" r="45"></circle>
            <circle class="progress-bar" cx="50" cy="50" r="45"></circle>
        </svg>
        <button class="record-btn" onclick="startRecording()" id="recordBtn">▶</button>
    </div>
    <div style="width:50px;"></div>
</div>

<!-- Music picker -->
<div id="controls">
    <input type="file" id="musicInput" accept="audio/*" class="form-control mb-2">
</div>

<script>
let recordedChunks = [];
let stream, mediaRecorder;

async function startRecording() {
    const progress = document.querySelector('.progress-bar');
    const recordBtn = document.getElementById("recordBtn");
    const musicFile = document.getElementById("musicInput").files[0];
    if(!musicFile){ alert("Please select music!"); return; }

    // Play music audibly
    const musicURL = URL.createObjectURL(musicFile);
    const audioElement = new Audio(musicURL);
    audioElement.play();

    // Get camera + mic
    stream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });

    document.getElementById('preview').srcObject = stream;

    // Create AudioContext to mix mic + music
    const audioContext = new AudioContext();
    const destination = audioContext.createMediaStreamDestination();

    // Mic track
    const micSource = audioContext.createMediaStreamSource(stream);
    micSource.connect(destination);

    // Music track
    const musicSource = audioContext.createMediaElementSource(audioElement);
    musicSource.connect(destination);

    // Combine video + mixed audio
    const combinedStream = new MediaStream([...stream.getVideoTracks(), ...destination.stream.getAudioTracks()]);

    document.getElementById('preview').srcObject = combinedStream;

    // Record
    mediaRecorder = new MediaRecorder(combinedStream);
    mediaRecorder.ondataavailable = e => { if(e.data.size>0) recordedChunks.push(e.data); };
    mediaRecorder.start();

    // Start progress animation
    progress.style.transition = "stroke-dashoffset 5s linear";
    progress.style.strokeDashoffset = "0";

    // Start countdown inside button
    let countdown = 5;
    recordBtn.textContent = countdown;
    recordBtn.classList.add("pulsing");
    const interval = setInterval(() => {
        countdown--;
        recordBtn.textContent = countdown>0? countdown : "✔";
        if(countdown <= 0) clearInterval(interval);
    }, 1000);

    // Stop after 5 seconds
    setTimeout(() => { 
        mediaRecorder.stop(); 
        audioElement.pause();
        progress.style.transition = "none"; 
        progress.style.strokeDashoffset = "283";
        recordBtn.classList.remove("pulsing");
        recordBtn.textContent = "▶";
    }, 5000);

    mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks,{type:'video/webm'});
        const formData = new FormData();
        formData.append("video", blob, "video_with_music.webm");

        fetch("upload.php",{method:"POST",body:formData})
            .then(res=>res.text())
            .then(data=>alert(data));

        // Stop tracks
        stream.getTracks().forEach(t=>t.stop());
        audioContext.close();
        recordedChunks = [];
    };
}
</script>

</body>
</html>
