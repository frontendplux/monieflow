<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Video + Mic + Music Recorder</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body{
    background:#111;
    color:white;
    text-align:center;
}

video{
    width:90%;
    max-height:70vh;
    object-fit:cover;
    margin-top:20px;
    border-radius:10px;
}

.record-btn{
    width:80px;
    height:80px;
    background:red;
    border-radius:50%;
    border:none;
    margin-top:20px;
    cursor:pointer;
}

.controls{
    margin-top:15px;
}
</style>
</head>
<body>

<h3 class="mt-3">Record Video + Mic + Music</h3>

<!-- Music Player -->
<audio id="musicPlayer" controls class="mt-3">
    <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3" type="audio/mp3">
</audio>

<!-- Camera Preview -->
<video id="preview" autoplay muted></video>

<!-- Record Button -->
<div>
    <button class="record-btn" onclick="startRecording()"></button>
</div>

<!-- Volume Controls -->
<div class="controls">
    <label>Mic Volume</label>
    <input type="range" id="micVolume" min="0" max="2" step="0.1" value="1">
    
    <label class="ms-3">Music Volume</label>
    <input type="range" id="musicVolume" min="0" max="2" step="0.1" value="0.7">
</div>

<script>
let recordedChunks = [];
let mediaRecorder;
let micGain, musicGain;

async function startRecording(){

    const preview = document.getElementById('preview');
    const musicElement = document.getElementById('musicPlayer');

    // Play music
    musicElement.play();

    // Get camera + mic
    const userStream = await navigator.mediaDevices.getUserMedia({
        video:true,
        audio:true
    });

    // Create Audio Context
    const audioContext = new AudioContext();
    await audioContext.resume();

    const destination = audioContext.createMediaStreamDestination();

    /* ======================
       MICROPHONE SETUP
    ====================== */
    const micSource = audioContext.createMediaStreamSource(userStream);
    micGain = audioContext.createGain();
    micGain.gain.value = document.getElementById("micVolume").value;

    micSource.connect(micGain);
    micGain.connect(destination);

    /* ======================
       MUSIC SETUP
    ====================== */
    const musicSource = audioContext.createMediaElementSource(musicElement);
    musicGain = audioContext.createGain();
    musicGain.gain.value = document.getElementById("musicVolume").value;

    musicSource.connect(musicGain);
    musicGain.connect(destination); // to recorder
    musicGain.connect(audioContext.destination); // to speakers

    /* ======================
       COMBINE STREAM
    ====================== */
    const combinedStream = new MediaStream([
        ...userStream.getVideoTracks(),
        ...destination.stream.getAudioTracks()
    ]);

    preview.srcObject = combinedStream;

    // RECORD
    recordedChunks = [];
    mediaRecorder = new MediaRecorder(combinedStream);

    mediaRecorder.ondataavailable = e => {
        if(e.data.size > 0) recordedChunks.push(e.data);
    };

    mediaRecorder.start();

    // Stop after 5 seconds
    setTimeout(()=>{
        mediaRecorder.stop();
        userStream.getTracks().forEach(track=>track.stop());
        audioContext.close();
    },5000);

    mediaRecorder.onstop = ()=>{
        const blob = new Blob(recordedChunks,{type:'video/webm'});
        uploadVideo(blob);
    };
}

/* ======================
   Upload to PHP
====================== */
function uploadVideo(blob){
    const formData = new FormData();
    formData.append("video", blob, "recorded_video.webm");

    fetch("upload.php",{
        method:"POST",
        body:formData
    })
    .then(res=>res.text())
    .then(data=>alert(data));
}

/* ======================
   Volume Controls Live
====================== */
document.getElementById("micVolume").addEventListener("input",function(){
    if(micGain) micGain.gain.value = this.value;
});

document.getElementById("musicVolume").addEventListener("input",function(){
    if(musicGain) musicGain.gain.value = this.value;
});
</script>

</body>
</html>
