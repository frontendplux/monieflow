<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>15 Sec Record Button</title>
    <style>
        .record-wrapper {
            position: relative;
            width: 100px;
            height: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* The SVG Ring */
        svg {
            position: absolute;
            transform: rotate(-90deg); /* Start from the top */
        }

        circle {
            fill: none;
            stroke-width: 6;
        }

        .progress-bg {
            stroke: #333;
        }

        .progress-bar {
            stroke: red;
            /* Circumference = 2 * π * r (2 * 3.14159 * 45 ≈ 283) */
            stroke-dasharray: 283; 
            stroke-dashoffset: 283;
            transition: none;
        }

        /* The Button Inside */
        .record-btn {
            width: 70px;
            height: 70px;
            background: red;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            z-index: 10;
            transition: transform 0.2s ease;
        }

        .record-btn:active {
            transform: scale(0.9);
        }
    </style>
</head>

<body class="bg-dark">

<div class="position-fixed top-0 bottom-0 start-0 end-0">
    <video id="preview" autoplay muted class="h-100 w-100"></video>
</div>
 
<div class="position-fixed bottom-0 start-0 end-0 d-flex justify-content-around align-items-center mb-4">
    <a href="#"><img class="rounded-2 border-warning border border-2" src="https://picsum.photos/50" alt="Post content" style="width: 50px; height: 50px;"></a>
    <div class="record-wrapper">
        <svg width="100" height="100">
            <circle class="progress-bg" cx="50" cy="50" r="45"/>
            <circle class="progress-bar" cx="50" cy="50" r="45"/>
        </svg>
        <button class="record-btn" onclick="startRecording()"></button>
    </div>
    
    <div style="width: 50px;"></div> </div>

<script>

// var istrue=false;
// async function startRecording() {
//     const progress = document.querySelector('.progress-bar');
//     // startLoading() 
//     stream = await navigator.mediaDevices.getUserMedia({
//         video: true,
//         audio: true
//     });
//     // load stream into view 
//     document.getElementById('preview').srcObject = stream;
//     mediaRecorder = new MediaRecorder(stream);
//     mediaRecorder.ondataavailable = event => {
//         if (event.data.size > 0) {
//             recordedChunks.push(event.data);
//         }
//     };

//    if (istrue){ 
//         progress.style.transition = "none";
//         progress.style.strokeDashoffset = "283";
//         mediaRecorder.stop()
//         istrue=false;
//     }

//     else{
//         progress.style.transition = "stroke-dashoffset 5s linear";
//         progress.style.strokeDashoffset = "0"
//         mediaRecorder.start();
//         istrue=true;
//     }
//     // --------------------when media stops
//     mediaRecorder.onstop = () => {
//         const blob = new Blob(recordedChunks, { type: 'video/webm' });
//         uploadVideo(blob);
//         recordedChunks = [];
//         // Stop camera
//         stream.getTracks().forEach(track => track.stop());
        
//     };
   
//     // ⏳ Auto stop after 5 seconds
//     setTimeout(() => {
//         mediaRecorder.stop();
//         progress.style.transition = "none";
//         progress.style.strokeDashoffset = "283";
//         istrue=false;
//     }, 5000);
// }

// function startLoading() {
//     const progress = document.querySelector('.progress-bar');
//     // Reset to start immediately in case it was clicked before
//     progress.style.transition = "none";
//     progress.style.strokeDashoffset = "283";
//     // Small timeout to allow the "reset" to register before animating
//     setTimeout(() => {
//         progress.style.transition = "stroke-dashoffset 5s linear";
//         progress.style.strokeDashoffset = "0";
//     }, 0);

//     // Reset after 15 seconds
//     setTimeout(() => {
//         progress.style.transition = "none";
//         progress.style.strokeDashoffset = "283";
//         alert("Recording Finished!");
//     }, 5000);
// }

// function uploadVideo(blob) {
//     alert(blob);
// }

</script>
<input type="file" id="musicInput" accept="audio/*" class="mb-2">
<script>
let recordedChunks = [];
let stream, mediaRecorder;

async function startRecording() {
    const progress = document.querySelector('.progress-bar');
    // const musicFile = document.getElementById("musicInput").files[0];

    // if (!musicFile) {
    //     alert("Please select music first!");
    //     return;
    // }

    stream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
    document.getElementById('preview').srcObject = stream;

    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.ondataavailable = e => {
        if(e.data.size > 0) recordedChunks.push(e.data);
    };

    mediaRecorder.onstop = async () => {
        const videoBlob = new Blob(recordedChunks, { type: 'video/webm' });
        uploadFiles(videoBlob);
        recordedChunks = [];
        stream.getTracks().forEach(track => track.stop());
    };

    progress.style.transition = "stroke-dashoffset 5s linear";
    progress.style.strokeDashoffset = "0";

    mediaRecorder.start();

    setTimeout(() => {
        mediaRecorder.stop();
        progress.style.transition = "none";
        progress.style.strokeDashoffset = "283";
    }, 5000); // 5 seconds
}

function uploadFiles(videoBlob, musicFile) {
    const formData = new FormData();
    formData.append("video", videoBlob, "video.webm");
    formData.append("music", musicFile);

    fetch("upload.php", { method:"POST", body:formData })
        .then(res => res.text())
        .then(data => alert(data));
}
</script>

</body>
</html>