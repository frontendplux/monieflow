<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Record + Music Upload</title>
</head>
<body>

<video id="preview" autoplay muted width="300"></video>
<br><br>

<input type="file" id="musicInput" accept="audio/*">
<br><br>

<button onclick="startRecording()">Record 15s</button>

<script>
let mediaRecorder;
let recordedChunks = [];
let stream;

async function startRecording(){

    stream = await navigator.mediaDevices.getUserMedia({
        video:true,
        audio:true
    });

    document.getElementById("preview").srcObject = stream;

    mediaRecorder = new MediaRecorder(stream);

    mediaRecorder.ondataavailable = e=>{
        if(e.data.size>0){
            recordedChunks.push(e.data);
        }
    };

    mediaRecorder.onstop = ()=>{
        const videoBlob = new Blob(recordedChunks,{type:"video/webm"});
        uploadFiles(videoBlob);
        recordedChunks = [];
        stream.getTracks().forEach(track=>track.stop());
    };

    mediaRecorder.start();

    setTimeout(()=>{
        mediaRecorder.stop();
    },15000);
}

function uploadFiles(videoBlob){

    const musicFile = document.getElementById("musicInput").files[0];

    if(!musicFile){
        alert("Please select music first!");
        return;
    }

    const formData = new FormData();
    formData.append("video", videoBlob, "video.webm");
    formData.append("music", musicFile);

    fetch("m.php",{
        method:"POST",
        body:formData
    })
    .then(res=>res.text())
    .then(data=>alert(data));
}
</script>

</body>
</html>
