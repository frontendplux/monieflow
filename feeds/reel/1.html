<!DOCTYPE html>
<html>
<head>
    <title>Snap Filter Demo</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: black; }
        canvas { position: absolute; }
        video { display: none; }
        button {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            font-size: 16px;
        }
    </style>
</head>
<body>

<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>
<button onclick="capture()">Capture</button>

<script>
    const videoElement = document.getElementById('video');
const canvasElement = document.getElementById('canvas');
const canvasCtx = canvasElement.getContext('2d');

canvasElement.width = window.innerWidth;
canvasElement.height = window.innerHeight;

const glasses = new Image();
glasses.src = "glasses.png"; // transparent PNG glasses

const faceMesh = new FaceMesh({
    locateFile: (file) => {
        return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
    }
});

faceMesh.setOptions({
    maxNumFaces: 1,
    refineLandmarks: true,
    minDetectionConfidence: 0.5,
    minTrackingConfidence: 0.5
});

faceMesh.onResults(onResults);

const camera = new Camera(videoElement, {
    onFrame: async () => {
        await faceMesh.send({ image: videoElement });
    },
    width: 640,
    height: 480
});
camera.start();

function onResults(results) {
    canvasCtx.save();
    canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
    canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

    if (results.multiFaceLandmarks.length > 0) {
        const landmarks = results.multiFaceLandmarks[0];

        // Left eye = 33
        // Right eye = 263
        const leftEye = landmarks[33];
        const rightEye = landmarks[263];

        const x1 = leftEye.x * canvasElement.width;
        const y1 = leftEye.y * canvasElement.height;
        const x2 = rightEye.x * canvasElement.width;
        const y2 = rightEye.y * canvasElement.height;

        const width = Math.abs(x2 - x1) * 2;
        const height = width * 0.5;

        const centerX = (x1 + x2) / 2 - width / 2;
        const centerY = (y1 + y2) / 2 - height / 2;

        canvasCtx.drawImage(glasses, centerX, centerY, width, height);
    }

    canvasCtx.restore();
}

function capture() {
    const image = canvasElement.toDataURL("image/png");

    fetch("save.php", {
        method: "POST",
        body: new URLSearchParams({ image: image })
    }).then(res => alert("Saved!"));
}

</script>
</body>
</html>

<?php
if(isset($_POST['image'])){
    $image = $_POST['image'];
    $image = str_replace('data:image/png;base64,', '', $image);
    $image = base64_decode($image);

    $file = 'uploads/' . time() . '.png';
    file_put_contents($file, $image);

    echo "saved";
}
?>

